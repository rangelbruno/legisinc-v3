# Sistema de Par√¢metros do Rodap√© - Documenta√ß√£o Completa

## üìã Vis√£o Geral

O sistema de par√¢metros do rodap√© permite configurar e gerenciar o texto, imagem e propriedades do rodap√© que ser√° utilizado nos documentos do sistema Legisinc. O sistema suporta tr√™s tipos de rodap√©: texto, imagem ou misto (texto + imagem).

## üöÄ Acesso ao Sistema

### URL Principal
```
GET/POST /parametros-templates-rodape
```

### Rotas Configuradas
- **GET** `/parametros-templates-rodape` - Exibe a tela de configura√ß√£o do rodap√©
- **POST** `/parametros-templates-rodape` - Salva as configura√ß√µes do rodap√©
- **POST** `/upload/rodape` - Upload da imagem do rodap√©

## üèóÔ∏è Arquitetura do Sistema

### Controllers Envolvidos

#### 1. TemplateFooterController
**Localiza√ß√£o**: `/app/Http/Controllers/TemplateFooterController.php`

**M√©todos principais**:
- `index()`: Exibe a tela de configura√ß√£o do rodap√©
- `store(Request $request)`: Salva as configura√ß√µes do rodap√©

**Par√¢metros configur√°veis**:
- `usar_rodape` (boolean): Ativa/desativa o rodap√© autom√°tico
- `rodape_tipo` (string): Tipo do rodap√© (texto, imagem, misto)
- `rodape_texto` (string): Texto do rodap√© (m√°ximo 500 caracteres)
- `rodape_posicao` (string): Posi√ß√£o (rodape, final, todas_paginas)
- `rodape_alinhamento` (string): Alinhamento (esquerda, centro, direita)
- `rodape_numeracao` (boolean): Incluir numera√ß√£o de p√°ginas

#### 2. ImageUploadController
**Localiza√ß√£o**: `/app/Http/Controllers/ImageUploadController.php`

**M√©todo espec√≠fico do rodap√©**:
- `uploadRodape(Request $request)`: Gerencia o upload da imagem do rodap√©

**Valida√ß√µes de upload**:
- Formatos aceitos: JPEG, JPG, PNG
- Tamanho m√°ximo: 2MB
- Nome do arquivo: `rodape.[extens√£o]`
- Recomenda√ß√£o: Imagem com fundo transparente

## üíæ Estrutura do Banco de Dados

### Organiza√ß√£o Hier√°rquica
```
M√≥dulo: "Templates" (ID: 6)
‚îî‚îÄ‚îÄ Subm√≥dulo: "Rodap√©"
    ‚îú‚îÄ‚îÄ Campo: "usar_rodape" ‚Üí boolean (true)
    ‚îú‚îÄ‚îÄ Campo: "rodape_tipo" ‚Üí string ("texto", "imagem", "misto")
    ‚îú‚îÄ‚îÄ Campo: "rodape_texto" ‚Üí text (max 500 chars)
    ‚îú‚îÄ‚îÄ Campo: "rodape_imagem" ‚Üí string (caminho da imagem)
    ‚îú‚îÄ‚îÄ Campo: "rodape_posicao" ‚Üí string ("rodape", "final", "todas_paginas")
    ‚îú‚îÄ‚îÄ Campo: "rodape_alinhamento" ‚Üí string ("esquerda", "centro", "direita")
    ‚îî‚îÄ‚îÄ Campo: "rodape_numeracao" ‚Üí boolean (true)
```

### Tabelas Utilizadas

#### parametros_modulos
```sql
- id: 6 (Templates)
- nome: "Templates"
- descricao: "Configura√ß√µes de templates do sistema"
- ativo: true
```

#### parametros_submodulos
```sql
- id: [auto]
- modulo_id: 6
- nome: "Rodap√©"
- descricao: "Configura√ß√µes do rodap√© dos documentos"
- ativo: true
```

#### parametros_campos
Campos espec√≠ficos do rodap√©:
```sql
- nome: "usar_rodape" | tipo: "boolean" | obrigatorio: false
- nome: "rodape_tipo" | tipo: "select" | opcoes: ["texto","imagem","misto"]
- nome: "rodape_texto" | tipo: "textarea" | max_length: 500
- nome: "rodape_imagem" | tipo: "image" | 
- nome: "rodape_posicao" | tipo: "select" | opcoes: ["rodape","final","todas_paginas"]
- nome: "rodape_alinhamento" | tipo: "radio" | opcoes: ["esquerda","centro","direita"]
- nome: "rodape_numeracao" | tipo: "boolean"
```

#### parametros_valores
```sql
- campo_id: [FK para parametros_campos]
- valor: [valor do par√¢metro]
- tipo_valor: "string", "boolean", etc.
- valido_ate: null (valor atual)
```

## üìÅ Armazenamento de Imagens

### Localiza√ß√£o F√≠sica
- **Diret√≥rio**: `/public/template/`
- **Arquivo padr√£o**: `rodape.png`
- **Permiss√µes**: 755 (criado automaticamente se n√£o existir)

### Processo de Upload
1. **Valida√ß√£o**: Arquivo deve ser imagem (JPEG/JPG/PNG) com m√°ximo 2MB
2. **Nomenclatura**: Arquivo renomeado para `rodape.[extens√£o]`
3. **Armazenamento**: Salvo em `/public/template/`
4. **Banco de dados**: Caminho relativo salvo como `template/rodape.[extens√£o]`
5. **Par√¢metro**: Valor atualizado em `Templates > Rodap√© > rodape_imagem`
6. **Cache**: Cache de par√¢metros invalidado automaticamente

## üîß Servi√ßos Utilizados

### ParametroService
**Localiza√ß√£o**: `/app/Services/Parametro/ParametroService.php`

**M√©todos para rodap√©**:
```php
// Obter configura√ß√µes espec√≠ficas
$this->parametroService->obterValor('Templates', 'Rodap√©', 'usar_rodape');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_tipo');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_texto');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_imagem');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_posicao');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_alinhamento');
$this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_numeracao');

// Salvar configura√ß√£o espec√≠fica
$this->parametroService->salvarValor('Templates', 'Rodap√©', 'rodape_texto', $valor);
```

### TemplateVariableService
**Localiza√ß√£o**: `/app/Services/Template/TemplateVariableService.php`

**Vari√°veis dispon√≠veis para templates**:
```php
$variables['rodape_texto'] = $this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_texto') ?: 'Documento oficial da C√¢mara Municipal';
$variables['rodape_numeracao'] = $this->parametroService->obterValor('Templates', 'Rodap√©', 'rodape_numeracao') ?: '1';
```

## üé® Interface do Usu√°rio

### Tela de Configura√ß√£o
**View**: `/resources/views/modules/parametros/templates/rodape.blade.php`

**Componentes principais**:

#### 1. Configura√ß√µes Gerais
- **Switch "Usar Rodap√©"**: Ativa/desativa rodap√© autom√°tico
- **Select "Tipo de Rodap√©"**: Escolha entre texto, imagem ou misto

#### 2. Configura√ß√£o de Texto
- **Textarea**: Texto do rodap√© (m√°ximo 500 caracteres)
- **Visibilidade**: Mostrado apenas quando tipo √© "texto" ou "misto"

#### 3. Configura√ß√£o de Imagem
- **Upload de imagem**: Preview com bot√µes alterar/cancelar/remover
- **Valida√ß√£o**: Frontend valida formato e tamanho
- **Visibilidade**: Mostrado apenas quando tipo √© "imagem" ou "misto"

#### 4. Posicionamento
- **Select "Posi√ß√£o"**: 
  - `rodape`: Rodap√© da p√°gina
  - `final`: Final do documento
  - `todas_paginas`: Todas as p√°ginas

#### 5. Formata√ß√£o
- **Radio "Alinhamento"**: Esquerda, centro, direita
- **Switch "Numera√ß√£o"**: Incluir numera√ß√£o de p√°ginas

#### 6. Preview em Tempo Real
- **Visualiza√ß√£o**: Mostra como ficar√° o rodap√©
- **Informa√ß√µes**: Exibe configura√ß√µes atuais
- **Atualiza√ß√£o**: Preview atualiza conforme altera√ß√µes

### JavaScript Frontend
**Funcionalidades**:
- **Toggle din√¢mico**: Mostra/oculta campos conforme tipo selecionado
- **Upload AJAX**: Upload de imagem com feedback visual
- **Preview em tempo real**: Atualiza√ß√£o autom√°tica da visualiza√ß√£o
- **Valida√ß√µes**: Formato de arquivo, tamanho, campos obrigat√≥rios
- **Feedback**: SweetAlert2 para confirma√ß√µes e erros

## üîÑ Fluxo de Funcionamento

### 1. Configura√ß√£o Initial (Seeder)
```php
// Valores padr√£o criados pelo sistema
'usar_rodape' => true
'rodape_tipo' => 'texto'
'rodape_texto' => 'Este documento foi gerado automaticamente pelo Sistema Legislativo.'
'rodape_imagem' => 'template/rodape.png'
'rodape_posicao' => 'rodape'
'rodape_alinhamento' => 'centro'
'rodape_numeracao' => true
```

### 2. Altera√ß√£o de Configura√ß√µes
1. **Interface**: Usu√°rio acessa `/parametros-templates-rodape`
2. **Carregamento**: `TemplateFooterController::index()` obt√©m configura√ß√µes atuais
3. **Exibi√ß√£o**: View renderiza formul√°rio com valores existentes
4. **Preview**: JavaScript atualiza preview conforme configura√ß√µes

### 3. Upload de Nova Imagem
1. **Sele√ß√£o**: Usu√°rio escolhe arquivo via interface
2. **Valida√ß√£o**: JavaScript valida formato (PNG/JPG/JPEG) e tamanho (max 2MB)
3. **Upload**: AJAX POST para `/upload/rodape`
4. **Processamento**: `ImageUploadController::uploadRodape()`:
   - Move arquivo para `/public/template/rodape.[ext]`
   - Salva caminho no BD via `ParametroService::salvarValor()`
   - Invalida cache de par√¢metros
   - Retorna URL para atualizar preview
5. **Feedback**: Preview atualizado e mensagem de sucesso

### 4. Salvamento de Configura√ß√µes
1. **Submiss√£o**: Formul√°rio enviado via AJAX POST
2. **Valida√ß√£o**: `TemplateFooterController::store()` valida dados:
   - `usar_rodape`: boolean
   - `rodape_tipo`: valores permitidos (texto/imagem/misto)
   - `rodape_texto`: m√°ximo 500 caracteres
   - `rodape_posicao`: valores permitidos
   - `rodape_alinhamento`: valores permitidos
   - `rodape_numeracao`: boolean
3. **Salvamento**: Cada configura√ß√£o salva individualmente via `ParametroService`
4. **Cache**: Invalida√ß√£o autom√°tica do cache
5. **Resposta**: JSON de sucesso/erro

### 5. Utiliza√ß√£o nos Templates
1. **Carregamento**: `TemplateVariableService::getTemplateVariables()` obt√©m valores
2. **Disponibiliza√ß√£o**: Vari√°veis dispon√≠veis para substitui√ß√£o:
   - `${rodape_texto}`: Texto configurado
   - `${rodape_numeracao}`: Status da numera√ß√£o
3. **Processamento**: Templates RTF/DOCX substituem vari√°veis
4. **Renderiza√ß√£o**: OnlyOffice exibe documento com rodap√© aplicado

## üìù Par√¢metros Configur√°veis

| Par√¢metro | Tipo | Valores Poss√≠veis | Padr√£o | Descri√ß√£o |
|-----------|------|------------------|---------|-----------|
| `usar_rodape` | boolean | true, false | `true` | Ativa/desativa rodap√© autom√°tico |
| `rodape_tipo` | string | texto, imagem, misto | `texto` | Tipo de conte√∫do do rodap√© |
| `rodape_texto` | string | max 500 chars | `Este documento foi gerado...` | Texto do rodap√© |
| `rodape_imagem` | string | caminho relativo | `template/rodape.png` | Caminho da imagem |
| `rodape_posicao` | string | rodape, final, todas_paginas | `rodape` | Posicionamento no documento |
| `rodape_alinhamento` | string | esquerda, centro, direita | `centro` | Alinhamento do conte√∫do |
| `rodape_numeracao` | boolean | true, false | `true` | Incluir numera√ß√£o de p√°ginas |

## üîí Permiss√µes e Seguran√ßa

### Autentica√ß√£o
- Sistema possui auto-login para usu√°rio admin (bruno@sistema.gov.br)
- Middleware de autentica√ß√£o aplicado nas rotas

### Valida√ß√µes
- **Upload**: Apenas imagens JPEG/JPG/PNG, m√°ximo 2MB
- **Texto**: M√°ximo 500 caracteres
- **Enums**: Valores de posi√ß√£o e alinhamento validados
- **Tipos**: Valida√ß√£o de tipos boolean e string

### Cache e Performance
- Cache autom√°tico das configura√ß√µes (TTL: 1 hora)
- Invalida√ß√£o autom√°tica ap√≥s altera√ß√µes
- Otimiza√ß√£o para reduzir consultas ao banco
- Preview JavaScript n√£o afeta performance do servidor

## üöÄ Como Usar em Novos Processos

### 1. Para Obter Configura√ß√µes do Rodap√©
```php
use App\Services\Parametro\ParametroService;

$parametroService = app(ParametroService::class);

// Verificar se rodap√© est√° ativo
$usarRodape = $parametroService->obterValor('Templates', 'Rodap√©', 'usar_rodape');

// Obter tipo de rodap√©
$tipoRodape = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_tipo');

// Obter texto do rodap√©
$textoRodape = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_texto');

// Obter imagem do rodap√©
$imagemRodape = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_imagem');
$urlImagem = asset($imagemRodape); // URL completa

// Obter todas as configura√ß√µes de uma vez
$configuracoes = $parametroService->obterConfiguracoes('Templates', 'Rodap√©');
```

### 2. Para Usar Vari√°veis nos Templates
```php
use App\Services\Template\TemplateVariableService;

$templateService = app(TemplateVariableService::class);
$variables = $templateService->getTemplateVariables();

// Vari√°veis dispon√≠veis:
$rodapeTexto = $variables['rodape_texto']; // "Documento oficial da C√¢mara Municipal"
$rodapeNumeracao = $variables['rodape_numeracao']; // "1" ou "0"

// Em templates RTF/DOCX usar:
// ${rodape_texto} - substitu√≠do pelo texto configurado
// ${rodape_numeracao} - substitu√≠do pelo status da numera√ß√£o
```

### 3. Para Aplicar Rodap√© Condicionalmente
```php
// Verificar se deve aplicar rodap√©
if ($parametroService->obterValor('Templates', 'Rodap√©', 'usar_rodape')) {
    $tipo = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_tipo');
    
    switch($tipo) {
        case 'texto':
            $texto = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_texto');
            // Aplicar apenas texto
            break;
            
        case 'imagem':
            $imagem = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_imagem');
            // Aplicar apenas imagem
            break;
            
        case 'misto':
            $texto = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_texto');
            $imagem = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_imagem');
            // Aplicar texto + imagem
            break;
    }
    
    // Configura√ß√µes de posicionamento
    $posicao = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_posicao');
    $alinhamento = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_alinhamento');
    $numeracao = $parametroService->obterValor('Templates', 'Rodap√©', 'rodape_numeracao');
}
```

### 4. Para Criar Novo Upload de Imagem Similar
```php
// M√©todo no ImageUploadController
public function uploadNovaImagemRodape(Request $request): JsonResponse
{
    $request->validate([
        'image' => 'required|image|mimes:jpeg,jpg,png|max:2048'
    ]);

    try {
        $file = $request->file('image');
        $fileName = 'nova-rodape.' . $file->getClientOriginalExtension();
        
        // Salvar em public/template
        $destinationPath = public_path('template');
        if (!file_exists($destinationPath)) {
            mkdir($destinationPath, 0755, true);
        }
        
        $file->move($destinationPath, $fileName);
        $relativePath = 'template/' . $fileName;
        
        // Salvar nos par√¢metros (criar novo campo se necess√°rio)
        $this->parametroService->salvarValor('Templates', 'Rodap√©', 'nova_imagem_rodape', $relativePath);
        
        return response()->json([
            'success' => true,
            'path' => $relativePath,
            'url' => asset($relativePath),
            'message' => 'Nova imagem do rodap√© enviada com sucesso!'
        ]);

    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => 'Erro ao enviar imagem: ' . $e->getMessage()
        ], 500);
    }
}
```

### 5. Para Criar Nova View de Configura√ß√£o
```php
// Controller
public function novaConfiguracaoRodape(): View
{
    $configuracoes = $this->obterConfiguracoes();
    $moduloId = ParametroModulo::where('nome', 'Templates')->first()->id ?? 6;
    
    return view('modules.parametros.templates.nova-rodape', compact('configuracoes', 'moduloId'));
}

// Obter configura√ß√µes personalizadas
private function obterConfiguracoes(): array
{
    return [
        'nova_config' => $this->parametroService->obterValor('Templates', 'Rodap√©', 'nova_config') ?: 'valor_padrao',
        // ... outras configura√ß√µes
    ];
}
```

## üõ†Ô∏è Comandos √öteis

### Verificar Configura√ß√µes Atuais
```bash
# Via tinker
php artisan tinker
>>> $service = app(\App\Services\Parametro\ParametroService::class);
>>> $service->obterConfiguracoes('Templates', 'Rodap√©');
```

### Limpar Cache
```bash
# Cache √© invalidado automaticamente, mas pode ser for√ßado
php artisan cache:clear
```

### Resetar Configura√ß√µes
```bash
# Executar seeder espec√≠fico
php artisan db:seed --class=ParametrosTemplatesSeeder
```

### Verificar Arquivos de Imagem
```bash
ls -la public/template/rodape*
```

## üêõ Troubleshooting

### Problemas Comuns

1. **Rodap√© n√£o aparece nos documentos**
   - Verificar se `usar_rodape` est√° `true`
   - Confirmar tipo configurado (texto/imagem/misto)
   - Validar se vari√°veis `${rodape_texto}` est√£o nos templates
   - Verificar logs de processamento de templates

2. **Upload de imagem falha**
   - Verificar permiss√µes da pasta `/public/template/`
   - Confirmar formato (PNG/JPG/JPEG) e tamanho (max 2MB)
   - Verificar se rota `/upload/rodape` est√° funcionando
   - Consultar logs do Laravel

3. **Configura√ß√µes n√£o salvam**
   - Verificar CSRF token na requisi√ß√£o
   - Confirmar estrutura do BD (Templates > Rodap√©)
   - Validar dados enviados no formul√°rio
   - Verificar logs de erro do `ParametroService`

4. **Preview n√£o atualiza**
   - Verificar JavaScript no console do navegador
   - Confirmar se SweetAlert2 est√° carregado
   - Testar eventos de mudan√ßa nos campos
   - Verificar se arquivo da view est√° correto

5. **Numera√ß√£o n√£o funciona**
   - Confirmar se `rodape_numeracao` est√° `true`
   - Verificar se template suporta numera√ß√£o
   - Testar em diferentes posi√ß√µes de rodap√©

### Logs Relevantes
- Upload de imagens: `storage/logs/laravel.log`
- Erros de par√¢metros: Buscar por "ParametroService"
- JavaScript: Console do navegador
- OnlyOffice: Logs espec√≠ficos do OnlyOffice

## üìö Arquivos Relacionados

### Controllers
- `/app/Http/Controllers/TemplateFooterController.php`
- `/app/Http/Controllers/ImageUploadController.php` (m√©todo `uploadRodape`)

### Services  
- `/app/Services/Parametro/ParametroService.php`
- `/app/Services/Template/TemplateVariableService.php`

### Views
- `/resources/views/modules/parametros/templates/rodape.blade.php`

### Migrations
- `/database/migrations/2025_07_18_000001_create_parametros_modulos_table.php`
- `/database/migrations/2025_07_18_000002_create_parametros_submodulos_table.php`
- `/database/migrations/2025_07_18_000003_create_parametros_campos_table.php`
- `/database/migrations/2025_07_18_000004_create_parametros_valores_table.php`

### Seeders
- `/database/seeders/ParametrosTemplatesSeeder.php`

### Rotas
- `/routes/web.php` (linhas 639-664, 908)

### JavaScript
- Inclu√≠do inline na view `rodape.blade.php` (linhas 404-626)

## üìä Estrutura de Arquivos

```
public/
‚îî‚îÄ‚îÄ template/
    ‚îú‚îÄ‚îÄ cabecalho.png
    ‚îú‚îÄ‚îÄ marca-dagua.png
    ‚îî‚îÄ‚îÄ rodape.png          ‚Üê Imagem do rodap√©

app/Http/Controllers/
‚îú‚îÄ‚îÄ TemplateFooterController.php    ‚Üê Controller principal
‚îî‚îÄ‚îÄ ImageUploadController.php       ‚Üê Upload de imagens

app/Services/
‚îú‚îÄ‚îÄ Parametro/
‚îÇ   ‚îî‚îÄ‚îÄ ParametroService.php       ‚Üê Gerenciamento de par√¢metros
‚îî‚îÄ‚îÄ Template/
    ‚îî‚îÄ‚îÄ TemplateVariableService.php ‚Üê Vari√°veis para templates

resources/views/modules/parametros/templates/
‚îî‚îÄ‚îÄ rodape.blade.php               ‚Üê Interface do usu√°rio

database/
‚îú‚îÄ‚îÄ migrations/                    ‚Üê Estrutura do BD
‚îî‚îÄ‚îÄ seeders/                      ‚Üê Dados iniciais
```

---

**Documenta√ß√£o criada em:** Agosto 2025  
**Vers√£o do sistema:** Legisinc v1.0  
**√öltima atualiza√ß√£o:** 13/08/2025