# Explica√ß√£o Detalhada - Etapas de Implementa√ß√£o do API Gateway

## üìö √çndice
1. [Vis√£o Geral da Estrat√©gia](#vis√£o-geral)
2. [Etapa 1: Instala√ß√£o do Gateway](#etapa-1-instala√ß√£o-do-gateway)
3. [Etapa 2: Shadow Traffic](#etapa-2-shadow-traffic)
4. [Etapa 3: Canary Deployment](#etapa-3-canary-deployment)
5. [Etapa 4: Migra√ß√£o Completa](#etapa-4-migra√ß√£o-completa)
6. [Etapa 5: Interface Administrativa](#etapa-5-interface-administrativa)

## üéØ Vis√£o Geral da Estrat√©gia {#vis√£o-geral}

### O Problema Atual
```
Hoje: Frontend ‚Üí Laravel (Monolito)
      Tudo acoplado, dif√≠cil de mudar
```

### A Solu√ß√£o Proposta
```
Futuro: Frontend ‚Üí Gateway ‚Üí Legacy OU Nova API OU API Externa
        Flex√≠vel, pode trocar backend sem tocar no frontend
```

### Como Vamos Chegar L√° (Sem Quebrar Nada)
1. **Colocar um "porteiro" (Gateway)** na frente de tudo
2. **Testar √†s escondidas** (Shadow Traffic)
3. **Migrar aos poucos** (Canary Deployment)
4. **Trocar gradualmente** endpoint por endpoint

---

## üö™ Etapa 1: Instala√ß√£o do Gateway {#etapa-1-instala√ß√£o-do-gateway}

### O Que √â Um API Gateway?

Imagine um **porteiro inteligente** do seu pr√©dio:
- Recebe todas as visitas (requisi√ß√µes)
- Decide para qual apartamento (backend) enviar
- Pode enviar para m√∫ltiplos apartamentos
- Controla quem entra e com que frequ√™ncia

### O Que Faremos Nesta Etapa

#### Dia 1-2: Instalar o Traefik (O Porteiro)

**Antes:**
```
Usu√°rio ‚Üí Laravel diretamente
```

**Depois:**
```
Usu√°rio ‚Üí Traefik ‚Üí Laravel (100% do tr√°fego ainda)
```

**O que o c√≥digo faz:**
```yaml
services:
  traefik:
    image: traefik:v3.0  # Baixa o "porteiro"
    ports:
      - "80:80"          # Escuta na porta 80 (web)

  laravel:
    image: legisinc/laravel  # Seu app atual
```

**Comando para rodar:**
```bash
docker-compose up -d
```

**O que acontece:**
- Traefik sobe e come√ßa a receber TODAS as requisi√ß√µes
- Por enquanto, ele apenas repassa tudo para o Laravel
- **Nada muda para o usu√°rio** (mesma URL, mesma resposta)

#### Dia 3: Adicionar Seguran√ßa e Monitoramento

**O que adicionamos:**
```yaml
# Rate Limiting (m√°ximo 100 requisi√ß√µes por minuto)
rate-limit:
  average: 100  # Protege contra spam/DDoS

# Headers de Seguran√ßa
security-headers:
  X-Frame-Options: DENY  # Previne clickjacking

# Request ID (rastreamento)
X-Request-ID: abc-123-def  # Cada requisi√ß√£o ganha um ID √∫nico
```

**Por qu√™?**
- **Rate Limit:** Evita que algu√©m fa√ßa 10.000 requisi√ß√µes e derrube o sistema
- **Security Headers:** Protege contra ataques comuns (XSS, clickjacking)
- **Request ID:** Permite rastrear uma requisi√ß√£o do in√≠cio ao fim

#### Dia 4-5: Observabilidade (Ver o que est√° acontecendo)

**Instalamos Prometheus + Grafana:**
```yaml
prometheus:
  # Coleta m√©tricas a cada 15 segundos

grafana:
  # Mostra gr√°ficos bonitos das m√©tricas
```

**O que voc√™ ver√° no Grafana:**
- Quantas requisi√ß√µes por segundo
- Tempo de resposta (est√° r√°pido ou lento?)
- Taxa de erro (quantos 500, 404, etc)
- Sa√∫de do sistema

**Exemplo de m√©trica:**
```
"Nas √∫ltimas 24h:
 - 50.000 requisi√ß√µes
 - 99.8% sucesso
 - Tempo m√©dio: 150ms"
```

### ‚úÖ Resultado da Etapa 1
- Gateway instalado e funcionando
- TODO tr√°fego passa por ele
- Temos m√©tricas e seguran√ßa
- **Zero impacto no usu√°rio**
- **Podemos fazer rollback instant√¢neo** (s√≥ desligar o gateway)

---

## üëª Etapa 2: Shadow Traffic (Tr√°fego Fantasma) {#etapa-2-shadow-traffic}

### O Que √â Shadow Traffic?

√â como ter um **espi√£o invis√≠vel**:
- Copia cada requisi√ß√£o
- Envia para a nova API
- **N√ÉO** usa a resposta da nova API
- Usu√°rio continua recebendo resposta do Laravel

### Para Que Serve?

**Testar sem risco:**
- A nova API est√° respondendo?
- As respostas s√£o iguais √†s do Laravel?
- A performance √© boa?
- Tem algum erro?

### Como Implementamos

#### Semana 1: Configurar o Espelhamento

**Configura√ß√£o no Gateway:**
```nginx
location /api/proposicoes {
    mirror /shadow;  # Copia a requisi√ß√£o
    proxy_pass http://laravel;  # Produ√ß√£o continua no Laravel
}

location /shadow {
    internal;  # N√£o acess√≠vel externamente
    proxy_pass http://nova-api;  # Envia c√≥pia para nova API
}
```

**O que acontece:**
1. Usu√°rio faz requisi√ß√£o para `/api/proposicoes`
2. Gateway envia para Laravel (normal)
3. Gateway TAMB√âM envia c√≥pia para Nova API
4. Resposta do Laravel vai para o usu√°rio
5. Resposta da Nova API vai para os logs (an√°lise)

#### Semana 1-2: An√°lise dos Resultados

**Script de compara√ß√£o:**
```bash
# Compara respostas do Legacy vs Nova API
./compare-responses.sh

Resultado:
- 1000 requisi√ß√µes analisadas
- 95% id√™nticas ‚úÖ
- 3% diferen√ßa em campos opcionais ‚ö†Ô∏è
- 2% erro na nova API ‚ùå
```

**O que fazemos com isso:**
- ‚úÖ 95% id√™nticas = √≥timo!
- ‚ö†Ô∏è 3% diferen√ßas = investigar e corrigir
- ‚ùå 2% erros = DEVE corrigir antes de prosseguir

### ‚úÖ Resultado da Etapa 2
- Nova API testada com tr√°fego real
- **Zero risco** (usu√°rios nem sabem)
- Identificamos problemas ANTES de migrar
- Temos confian√ßa para pr√≥ximo passo

---

## üê§ Etapa 3: Canary Deployment (Implanta√ß√£o Can√°rio) {#etapa-3-canary-deployment}

### O Que √â Canary Deployment?

Nome vem dos **can√°rios nas minas de carv√£o** (detectavam gases t√≥xicos).

No nosso caso:
- 1% dos usu√°rios usam a nova API (os "can√°rios")
- 99% continuam no Laravel (seguro)
- Se o 1% tiver problemas, voltamos tudo

### Como Funciona na Pr√°tica

#### Semana 2: Come√ßar com 1%

**Configura√ß√£o:**
```yaml
proposicoes-weighted:
  services:
    - name: "nova-api"
      weight: 1    # 1% do tr√°fego
    - name: "laravel"
      weight: 99   # 99% do tr√°fego
```

**O que acontece:**
- De cada 100 requisi√ß√µes:
  - 1 vai para Nova API
  - 99 v√£o para Laravel
- Se a 1 requisi√ß√£o falhar, apenas 1 usu√°rio √© afetado

#### Progress√£o Gradual

**Dia 1:** 1% canary
```
Monitorando...
‚úÖ Sem erros em 4 horas
‚Üí Aumentar para 5%
```

**Dia 2:** 5% canary
```
Monitorando...
‚úÖ Taxa de erro < 0.1%
‚úÖ Lat√™ncia similar ao Laravel
‚Üí Aumentar para 10%
```

**Dia 3:** 10% canary
```
Monitorando...
‚úÖ 10.000 requisi√ß√µes processadas
‚úÖ Zero reclama√ß√µes de usu√°rios
‚Üí Aumentar para 25%
```

**Dia 4:** 25% canary
```
Monitorando...
‚ö†Ô∏è Lat√™ncia aumentou 50ms
‚Üí Investigar e otimizar
‚Üí Manter em 25% por enquanto
```

**Dia 5:** 25% canary (ap√≥s otimiza√ß√£o)
```
‚úÖ Lat√™ncia normalizada
‚Üí Aumentar para 50%
```

**Semana 3:** 50% ‚Üí 75% ‚Üí 100%

### Sistema de Alertas

**Alerta autom√°tico se:**
```yaml
# Taxa de erro > 1%
if error_rate > 0.01:
  alert("CR√çTICO: Nova API com muitos erros!")
  rollback_to_legacy()

# Lat√™ncia > 500ms
if p95_latency > 500ms:
  alert("AVISO: Nova API lenta!")
  reduce_canary_to_10()
```

### Rollback de Emerg√™ncia (Voltar Tudo)

**Se algo der muito errado:**
```bash
./emergency-rollback.sh

# O que o script faz:
1. Para TODO tr√°fego para Nova API
2. Envia 100% para Laravel
3. Notifica equipe no Slack
4. Salva logs para an√°lise

Tempo total: 30 segundos
```

### ‚úÖ Resultado da Etapa 3
- Nova API validada com tr√°fego real crescente
- Problemas detectados e corrigidos gradualmente
- **Rollback sempre dispon√≠vel**
- Confian√ßa para migra√ß√£o completa

---

## üöÄ Etapa 4: Migra√ß√£o Completa {#etapa-4-migra√ß√£o-completa}

### Estrat√©gia de Migra√ß√£o por Tipo de Endpoint

#### Fase 1: Endpoints Read-Only (Mais Seguros)

**Por que come√ßar com GET?**
- N√£o alteram dados
- F√°cil fazer rollback
- Menor risco ao neg√≥cio

**Ordem de migra√ß√£o:**
```
1. GET /api/tipos-proposicao     (dados est√°ticos)
2. GET /api/parametros           (configura√ß√µes)
3. GET /api/parlamentares        (listagem simples)
4. GET /api/proposicoes          (listagem com filtros)
```

#### Fase 2: Endpoints de Cria√ß√£o (POST)

**Mais cuidado necess√°rio:**
```
1. POST /api/comentarios         (baixo impacto)
2. POST /api/anexos              (upload de arquivos)
3. POST /api/proposicoes         (cr√≠tico - criar gradualmente)
```

#### Fase 3: Endpoints de Atualiza√ß√£o (PUT/PATCH)

**Requer sincroniza√ß√£o de dados:**
```
1. PUT /api/perfil               (dados do usu√°rio)
2. PUT /api/proposicoes/{id}     (edi√ß√£o de proposi√ß√µes)
```

#### Fase 4: Endpoints Cr√≠ticos

**Migrar por √∫ltimo:**
```
1. POST /api/protocolar          (gera n√∫mero oficial)
2. POST /api/assinar             (assinatura digital)
3. POST /api/publicar            (publica√ß√£o oficial)
```

### Como Migrar Cada Endpoint

**Exemplo: Migrando GET /api/proposicoes**

**Passo 1: Implementar na Nova API**
```javascript
// nova-api/routes/proposicoes.js
app.get('/api/proposicoes', async (req, res) => {
  const proposicoes = await db.query('SELECT * FROM proposicoes');

  // Formato compat√≠vel com Laravel
  res.json({
    success: true,
    data: proposicoes,
    meta: { total: proposicoes.length }
  });
});
```

**Passo 2: Testes de Compatibilidade**
```bash
# Comparar resposta Laravel vs Nova API
curl http://laravel/api/proposicoes > laravel.json
curl http://nova-api/api/proposicoes > nova.json
diff laravel.json nova.json

# Deve ser id√™ntico (exceto timestamps)
```

**Passo 3: Ativar Roteamento**
```yaml
# gateway/routes.yml
/api/proposicoes:
  backend: nova-api  # Mudou de 'laravel' para 'nova-api'
```

**Passo 4: Monitorar**
```
Primeiras 24h ap√≥s migra√ß√£o:
- Taxa de erro: 0.01% ‚úÖ
- Lat√™ncia P95: 180ms ‚úÖ
- Reclama√ß√µes: 0 ‚úÖ
‚Üí Endpoint migrado com sucesso!
```

### ‚úÖ Resultado da Etapa 4
- Todos endpoints migrados gradualmente
- Sistema rodando 100% na Nova API
- Laravel pode ser desligado (ou mantido como backup)

---

## üéõÔ∏è Etapa 5: Interface Administrativa {#etapa-5-interface-administrativa}

### Para Que Serve?

Permitir que **usu√°rios n√£o-t√©cnicos** possam:
- Criar novas regras de neg√≥cio
- Modificar fluxos
- Criar endpoints customizados
- Sem precisar programar

### Exemplo Pr√°tico

**Cen√°rio:** "Quando uma proposi√ß√£o for aprovada, enviar email e gerar PDF"

**Antes (C√≥digo):**
```php
if ($proposicao->status === 'APROVADA') {
    Mail::send(...);
    PDF::generate(...);
}
```

**Depois (Interface Visual):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ QUANDO                      ‚îÇ
‚îÇ [Proposi√ß√£o] [status] [=] [APROVADA] ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ ENT√ÉO                       ‚îÇ
‚îÇ ‚úì Enviar Email para [autor]‚îÇ
‚îÇ ‚úì Gerar PDF                ‚îÇ
‚îÇ ‚úì Notificar Telegram       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
[Salvar Regra]
```

### Op√ß√µes de Implementa√ß√£o

#### Op√ß√£o 1: Strapi (Recomendado para Come√ßar)

**O que √©:** CMS headless que gera APIs automaticamente

**Como usar:**
```bash
# Instalar
npx create-strapi-app legisinc-cms

# Acessar interface: http://localhost:1337/admin
```

**Na interface visual:**
1. Criar tipo "Proposi√ß√£o"
2. Adicionar campos (titulo, conteudo, status)
3. Clicar "Save"
4. **API criada automaticamente!**

**Resultado:**
```
GET/POST     /api/proposicoes
GET/PUT/DEL  /api/proposicoes/:id
```

#### Op√ß√£o 2: n8n (Workflows Visuais)

**O que √©:** Ferramenta de automa√ß√£o visual (tipo Zapier)

**Exemplo de workflow:**
```
[Webhook] ‚Üí [Filtro] ‚Üí [Database] ‚Üí [Email] ‚Üí [Resposta]
   ‚Üì           ‚Üì          ‚Üì           ‚Üì          ‚Üì
Recebe    Se aprovada  Salva BD   Notifica   Retorna
request                            autor      sucesso
```

#### Op√ß√£o 3: Interface Customizada Simples

**Tela de cria√ß√£o de regras:**
```html
<form id="rule-builder">
  <h3>Nova Regra de Neg√≥cio</h3>

  <label>Endpoint:</label>
  <input type="text" placeholder="/api/custom/minha-regra">

  <label>Quando:</label>
  <select>
    <option>Campo X = Valor Y</option>
    <option>Usu√°rio tem permiss√£o Z</option>
  </select>

  <label>Ent√£o:</label>
  <checkbox>‚ñ° Salvar no banco</checkbox>
  <checkbox>‚ñ° Enviar email</checkbox>
  <checkbox>‚ñ° Chamar API externa</checkbox>

  <button>Criar Endpoint</button>
</form>
```

### Seguran√ßa da Interface Administrativa

**Regras importantes:**
1. **Apenas admins** podem criar regras
2. **Sem c√≥digo arbitr√°rio** (no eval, no exec)
3. **A√ß√µes pr√©-definidas** (n√£o pode fazer "qualquer coisa")
4. **Valida√ß√£o** antes de publicar
5. **Versionamento** de regras (poder voltar vers√£o anterior)

### ‚úÖ Resultado da Etapa 5
- Regras de neg√≥cio configur√°veis sem c√≥digo
- Endpoints criados dinamicamente
- Maior autonomia para usu√°rios de neg√≥cio
- Menor depend√™ncia de desenvolvedores

---

## üìä Resumo Executivo

### Linha do Tempo Total

| Semana | O Que Fazemos | Risco | Resultado |
|--------|---------------|-------|-----------|
| **1** | Instalar Gateway + Shadow Traffic | Zero | Infraestrutura pronta |
| **2** | Primeiro Canary (1% ‚Üí 10%) | Baixo | Valida√ß√£o inicial |
| **3** | Canary 25% ‚Üí 50% | M√©dio | Metade migrada |
| **4** | Canary 75% ‚Üí 100% | M√©dio | Migra√ß√£o completa |
| **5** | Interface Admin | Baixo | Autonomia de neg√≥cio |

### Benef√≠cios Finais

1. **Flexibilidade Total**
   - Pode trocar backend sem tocar frontend
   - Pode usar m√∫ltiplas APIs/linguagens
   - Pode integrar servi√ßos externos

2. **Seguran√ßa na Migra√ß√£o**
   - Shadow traffic = teste sem risco
   - Canary = migra√ß√£o gradual
   - Rollback = volta instant√¢nea

3. **Observabilidade**
   - M√©tricas em tempo real
   - Alertas autom√°ticos
   - Decis√µes baseadas em dados

4. **Autonomia**
   - Interface administrativa
   - Regras sem c√≥digo
   - Menor depend√™ncia de TI

### Comandos Essenciais

```bash
# Come√ßar
docker-compose up -d

# Ver m√©tricas
http://localhost:3000 (Grafana)

# Ativar shadow
./enable-shadow.sh /api/endpoint

# Mudar canary
./set-canary.sh /api/endpoint 10

# Emerg√™ncia
./emergency-rollback.sh
```

### Custos

- **Infraestrutura:** +1 servidor para Gateway (ou usar existente)
- **Ferramentas:** Todas open-source (gr√°tis)
- **Tempo:** 4-5 semanas de implementa√ß√£o
- **Equipe:** 1-2 desenvolvedores

### ROI (Retorno do Investimento)

- **Redu√ß√£o de 70%** no tempo de mudan√ßas futuras
- **Zero downtime** em atualiza√ß√µes
- **Possibilidade** de trocar tecnologia sem refazer tudo
- **Autonomia** para equipe de neg√≥cios

---

## üéØ Pr√≥ximo Passo Imediato

```bash
# 1. Criar pasta do projeto
mkdir legisinc-gateway
cd legisinc-gateway

# 2. Criar docker-compose.yml (copiar do documento)
vim docker-compose.yml

# 3. Subir gateway
docker-compose up -d

# 4. Testar
curl http://localhost/api/health

# 5. Celebrar! üéâ
echo "Gateway funcionando!"
```

**Tempo para ter o gateway rodando: 30 minutos**

---

*Este documento explica em detalhes cada etapa da migra√ß√£o.*
*Qualquer d√∫vida, consulte os documentos t√©cnicos complementares.*