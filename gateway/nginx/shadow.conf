# Nginx Configuration for Shadow Traffic
# Envia requisições para Laravel (produção) e copia para Nova API (shadow)

upstream laravel_backend {
    server legisinc-app:80 max_fails=3 fail_timeout=30s;
}

upstream nova_api_backend {
    server legisinc-nova-api:3001 max_fails=3 fail_timeout=30s;
}

# Log format personalizado para shadow traffic
log_format shadow_json escape=json '{'
  '"timestamp":"$time_iso8601",'
  '"method":"$request_method",'
  '"uri":"$request_uri",'
  '"status":"$status",'
  '"response_time":"$request_time",'
  '"upstream_response_time":"$upstream_response_time",'
  '"bytes_sent":"$bytes_sent",'
  '"user_agent":"$http_user_agent",'
  '"x_request_id":"$http_x_request_id",'
  '"upstream":"$upstream_addr",'
  '"shadow":false'
'}';

log_format shadow_mirror_json escape=json '{'
  '"timestamp":"$time_iso8601",'
  '"method":"$request_method",'
  '"uri":"$request_uri",'
  '"status":"$status",'
  '"response_time":"$request_time",'
  '"upstream_response_time":"$upstream_response_time",'
  '"bytes_sent":"$bytes_sent",'
  '"user_agent":"$http_user_agent",'
  '"x_request_id":"$http_x_request_id",'
  '"upstream":"$upstream_addr",'
  '"shadow":true'
'}';

server {
    listen 80;
    server_name _;

    # Logs separados para análise
    access_log /var/log/nginx/shadow_production.log shadow_json;
    error_log /var/log/nginx/shadow_error.log warn;

    # Request ID para rastreamento
    add_header X-Request-ID $request_time-$remote_addr-$remote_port always;

    # =================================
    # SHADOW TRAFFIC: /api/parlamentares/buscar
    # =================================
    location /api/parlamentares/buscar {
        # Espelhar para Nova API
        mirror /shadow/api/parlamentares/buscar;
        mirror_request_body on;

        # PRODUÇÃO: Laravel
        proxy_pass http://laravel_backend;
        proxy_set_header X-Request-ID $request_time-$remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts para produção
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # =================================
    # SHADOW TRAFFIC: /api/parlamentares
    # =================================
    location /api/parlamentares {
        # Espelhar para Nova API
        mirror /shadow/api/parlamentares;
        mirror_request_body on;

        # PRODUÇÃO: Laravel
        proxy_pass http://laravel_backend;
        proxy_set_header X-Request-ID $request_time-$remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts para produção
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # =================================
    # MIRROR LOCATIONS (shadow traffic)
    # =================================
    location /shadow/ {
        internal;  # Não acessível externamente

        # Log separado para shadow
        access_log /var/log/nginx/shadow_mirror.log shadow_mirror_json;

        # Remover /shadow do path
        rewrite ^/shadow(.*) $1 break;

        # Enviar para Nova API
        proxy_pass http://nova_api_backend;
        proxy_set_header X-Shadow-Request true;
        proxy_set_header X-Request-ID $request_time-$remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;

        # Timeouts baixos para shadow (não impactar produção)
        proxy_connect_timeout 1s;
        proxy_send_timeout 2s;
        proxy_read_timeout 2s;

        # Ignorar se cliente desconectar
        proxy_ignore_client_abort on;
    }

    # =================================
    # HEALTH CHECK
    # =================================
    location /health {
        proxy_pass http://laravel_backend;
        proxy_set_header X-Request-ID $request_time-$remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
    }

    # =================================
    # FALLBACK para outras rotas
    # =================================
    location / {
        proxy_pass http://laravel_backend;
        proxy_set_header X-Request-ID $request_time-$remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}