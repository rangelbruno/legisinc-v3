#!/bin/bash

echo "=== TESTE FINAL - Salvamento OnlyOffice Sem Duplica√ß√£o ==="
echo ""

echo "‚úÖ CORRE√á√ïES IMPLEMENTADAS:"
echo "1. Salvamento de arquivo DOCX + conte√∫do no banco"
echo "2. Preven√ß√£o de duplica√ß√£o ao reabrir documento"
echo "3. Logs detalhados para debug"
echo "4. Detec√ß√£o correta de arquivos j√° salvos"
echo ""

echo "üìã PROPOSI√á√ïES DISPON√çVEIS PARA TESTE:"
docker exec legisinc-postgres psql -U postgres -d legisinc -c "SELECT id, tipo, ementa, COALESCE(arquivo_path, 'sem arquivo') as arquivo_status FROM proposicoes ORDER BY id;"

echo ""
echo "üß™ INSTRU√á√ïES DE TESTE:"
echo ""
echo "TESTE COM PROPOSI√á√ÉO NOVA (ID: 3):"
echo "1. Acesse: http://localhost:8001"
echo "2. Login: jessica@sistema.gov.br / 123456"
echo "3. V√° em 'Minhas Proposi√ß√µes'"
echo "4. Abra a proposi√ß√£o ID 3 'Teste Limpo'"
echo "5. Clique em 'Continuar Edi√ß√£o no OnlyOffice'"
echo "6. Deve carregar template normal SEM duplica√ß√£o"
echo "7. Adicione texto: 'TESTE SALVAMENTO $(date +%H:%M:%S)'"
echo "8. Salve (Ctrl+S)"
echo "9. Feche e reabra - deve preservar o conte√∫do SEM duplicar"
echo ""
echo "RESULTADO ESPERADO:"
echo "- ‚úÖ Template aplicado uma vez s√≥"
echo "- ‚úÖ Conte√∫do salvo no banco e arquivo"
echo "- ‚úÖ Reabertura sem duplica√ß√£o"
echo "- ‚úÖ Edi√ß√µes preservadas"
echo ""

read -p "Pressione ENTER para monitorar logs durante o teste..."
echo "Monitorando... (Ctrl+C para parar)"

tail -f /home/bruno/legisinc/storage/logs/laravel.log | grep -E "regenera√ß√£o|arquivo.*salvo|tem_arquivo_salvo|callback.*status.*2"