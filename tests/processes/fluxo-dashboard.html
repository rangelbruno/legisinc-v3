<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Legisinc - Fluxo de Proposi√ß√µes</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn.success:hover {
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn.danger:hover {
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .flow-diagram {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-height: 800px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .status-success { color: #27ae60; }
        .status-error { color: #e74c3c; }
        .status-pending { color: #f39c12; }

        .logs-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            flex: 1;
        }

        .logs-content {
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-success { background: rgba(39, 174, 96, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-info { background: rgba(52, 152, 219, 0.2); }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            transform: scale(1.05);
        }

        .node-success {
            fill: #27ae60;
            stroke: #2ecc71;
        }

        .node-error {
            fill: #e74c3c;
            stroke: #c0392b;
        }

        .node-pending {
            fill: #f39c12;
            stroke: #e67e22;
        }

        .node-text {
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: white;
            pointer-events: none;
        }

        .link {
            stroke: #bdc3c7;
            stroke-width: 3;
            fill: none;
            transition: all 0.3s ease;
        }

        .link-active {
            stroke: #3498db;
            stroke-width: 4;
            animation: flow 2s infinite linear;
        }

        .link-success {
            stroke: #27ae60;
        }

        .link-error {
            stroke: #e74c3c;
        }

        @keyframes flow {
            0% { stroke-dasharray: 0 10; }
            100% { stroke-dasharray: 10 0; }
        }

        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .timeline-item:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .timeline-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: white;
            font-weight: bold;
        }

        .timeline-text {
            flex: 1;
            font-size: 0.9em;
        }

        .timeline-time {
            font-size: 0.8em;
            color: #6c757d;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üèõÔ∏è Dashboard Legisinc</h1>
            <p class="subtitle">Monitoramento em Tempo Real do Fluxo de Proposi√ß√µes</p>
        </div>

        <div class="controls">
            <button class="btn success" onclick="executarTeste()">
                <span>üöÄ</span> Executar Teste Completo
            </button>
            <button class="btn" onclick="resetarTeste()">
                <span>üîÑ</span> Resetar Sistema
            </button>
            <button class="btn" onclick="simularErro()">
                <span>‚ö†Ô∏è</span> Simular Erro
            </button>
            <button class="btn danger" onclick="pararTeste()">
                <span>‚èπÔ∏è</span> Parar Execu√ß√£o
            </button>
            <label style="margin-left: auto;">
                <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
            </label>
        </div>

        <div class="main-content">
            <div class="flow-diagram">
                <h3 style="margin-bottom: 20px;">üìä Diagrama de Fluxo Interativo</h3>
                <svg id="flowSvg" width="100%" height="700"></svg>
            </div>

            <div class="sidebar">
                <div class="stats-panel">
                    <h3>üìà Estat√≠sticas</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p id="progressText">Aguardando execu√ß√£o...</p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number status-success" id="sucessos">0</div>
                            <div class="stat-label">Sucessos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number status-error" id="erros">0</div>
                            <div class="stat-label">Erros</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number status-pending" id="pendentes">9</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="tempo">0s</div>
                            <div class="stat-label">Tempo</div>
                        </div>
                    </div>

                    <div class="timeline" id="timeline">
                        <h4 style="margin-bottom: 10px;">üïí Timeline</h4>
                    </div>
                </div>

                <div class="logs-panel">
                    <h3>üìã Logs de Execu√ß√£o</h3>
                    <div class="logs-content" id="logsContent">
                        <div class="log-entry log-info">[INFO] Sistema iniciado e pronto para execu√ß√£o</div>
                        <div class="log-entry log-info">[INFO] Dashboard carregado com sucesso</div>
                        <div class="log-entry log-info">[INFO] Aguardando comando de execu√ß√£o...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // Configura√ß√£o do fluxo
        const etapas = [
            { id: 'templates', name: 'Templates', x: 150, y: 100, icon: 'üîß', desc: 'Configura√ß√£o de Templates pelo Administrador' },
            { id: 'criacao', name: 'Cria√ß√£o', x: 400, y: 100, icon: 'üë§', desc: 'Cria√ß√£o de Proposi√ß√£o pelo Parlamentar' },
            { id: 'edicao', name: 'Edi√ß√£o', x: 650, y: 100, icon: '‚úèÔ∏è', desc: 'Edi√ß√£o de Proposi√ß√£o pelo Parlamentar' },
            { id: 'envio', name: 'Envio', x: 400, y: 250, icon: 'üì§', desc: 'Envio para o Legislativo' },
            { id: 'revisao', name: 'Revis√£o', x: 150, y: 250, icon: 'üèõÔ∏è', desc: 'Edi√ß√£o pelo Legislativo no OnlyOffice' },
            { id: 'retorno', name: 'Retorno', x: 150, y: 400, icon: '‚Ü©Ô∏è', desc: 'Retorno ao Parlamentar' },
            { id: 'assinatura', name: 'Assinatura', x: 400, y: 400, icon: '‚úçÔ∏è', desc: 'Assinatura Digital pelo Parlamentar' },
            { id: 'visualizacao', name: 'Visualiza√ß√£o', x: 650, y: 400, icon: 'üëÅÔ∏è', desc: 'Visualiza√ß√£o do PDF Assinado' },
            { id: 'protocolo', name: 'Protocolo', x: 400, y: 550, icon: 'üìã', desc: 'Protocolo e Numera√ß√£o Oficial' }
        ];

        const conexoes = [
            { source: 'templates', target: 'criacao' },
            { source: 'criacao', target: 'edicao' },
            { source: 'edicao', target: 'envio' },
            { source: 'envio', target: 'revisao' },
            { source: 'revisao', target: 'retorno' },
            { source: 'retorno', target: 'assinatura' },
            { source: 'assinatura', target: 'visualizacao' },
            { source: 'visualizacao', target: 'protocolo' }
        ];

        let statusEtapas = {};
        let executando = false;
        let tempoInicio = null;
        let intervaloTempo = null;
        let autoRefreshInterval = null;

        // Inicializar status
        etapas.forEach(etapa => {
            statusEtapas[etapa.id] = 'pending';
        });

        // Configurar SVG
        const svg = d3.select('#flowSvg');
        const g = svg.append('g');

        // Fun√ß√£o para desenhar o fluxo
        function desenharFluxo() {
            // Limpar conte√∫do anterior
            g.selectAll('*').remove();

            // Desenhar conex√µes
            const links = g.selectAll('.link')
                .data(conexoes)
                .enter()
                .append('path')
                .attr('class', d => {
                    const sourceStatus = statusEtapas[d.source];
                    const targetStatus = statusEtapas[d.target];
                    
                    let classes = 'link';
                    if (sourceStatus === 'success' && targetStatus === 'success') {
                        classes += ' link-success';
                    } else if (sourceStatus === 'error' || targetStatus === 'error') {
                        classes += ' link-error';
                    } else if (sourceStatus === 'success' && targetStatus === 'in_progress') {
                        classes += ' link-active';
                    }
                    return classes;
                })
                .attr('d', d => {
                    const source = etapas.find(e => e.id === d.source);
                    const target = etapas.find(e => e.id === d.target);
                    return `M ${source.x} ${source.y} L ${target.x} ${target.y}`;
                });

            // Desenhar n√≥s
            const nodes = g.selectAll('.node')
                .data(etapas)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x}, ${d.y})`);

            // C√≠rculos dos n√≥s
            nodes.append('circle')
                .attr('r', 30)
                .attr('class', d => `node-${statusEtapas[d.id]}`)
                .on('mouseover', function(event, d) {
                    mostrarTooltip(event, d);
                })
                .on('mouseout', esconderTooltip);

            // √çcones dos n√≥s
            nodes.append('text')
                .attr('class', 'node-text')
                .attr('font-size', '20px')
                .text(d => d.icon);

            // Labels dos n√≥s
            nodes.append('text')
                .attr('class', 'node-text')
                .attr('y', 50)
                .attr('font-size', '12px')
                .text(d => d.name);
        }

        function mostrarTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const status = statusEtapas[d.id];
            const statusText = {
                'pending': 'Pendente',
                'in_progress': 'Em Execu√ß√£o',
                'success': 'Conclu√≠do',
                'error': 'Erro'
            };

            tooltip.innerHTML = `
                <strong>${d.icon} ${d.name}</strong><br>
                <em>${d.desc}</em><br>
                <br>
                <strong>Status:</strong> ${statusText[status]}<br>
                <strong>ID:</strong> ${d.id}
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function esconderTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function atualizarEstatisticas() {
            const sucessos = Object.values(statusEtapas).filter(s => s === 'success').length;
            const erros = Object.values(statusEtapas).filter(s => s === 'error').length;
            const pendentes = Object.values(statusEtapas).filter(s => s === 'pending').length;
            
            document.getElementById('sucessos').textContent = sucessos;
            document.getElementById('erros').textContent = erros;
            document.getElementById('pendentes').textContent = pendentes;
            
            const progresso = (sucessos / etapas.length) * 100;
            document.getElementById('progressFill').style.width = progresso + '%';
            document.getElementById('progressText').textContent = 
                `Progresso: ${sucessos}/${etapas.length} etapas (${Math.round(progresso)}%)`;
        }

        function adicionarLog(tipo, mensagem) {
            const logsContent = document.getElementById('logsContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${tipo}`;
            logEntry.textContent = `[${timestamp}] ${mensagem}`;
            
            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;
            
            // Manter apenas os √∫ltimos 20 logs
            const logs = logsContent.children;
            if (logs.length > 20) {
                logsContent.removeChild(logs[0]);
            }
        }

        function adicionarTimeline(etapa, status) {
            const timeline = document.getElementById('timeline');
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            
            const etapaData = etapas.find(e => e.id === etapa);
            const icon = document.createElement('div');
            icon.className = `timeline-icon status-${status}`;
            icon.textContent = status === 'success' ? '‚úì' : status === 'error' ? '‚úó' : '‚è≥';
            
            const text = document.createElement('div');
            text.className = 'timeline-text';
            text.textContent = `${etapaData.icon} ${etapaData.name}`;
            
            const time = document.createElement('div');
            time.className = 'timeline-time';
            time.textContent = new Date().toLocaleTimeString();
            
            timelineItem.appendChild(icon);
            timelineItem.appendChild(text);
            timelineItem.appendChild(time);
            
            timeline.appendChild(timelineItem);
            
            // Manter apenas os √∫ltimos 10 itens
            const items = timeline.children;
            if (items.length > 11) { // +1 pelo t√≠tulo
                timeline.removeChild(items[1]); // N√£o remover o t√≠tulo
            }
        }

        function atualizarTempo() {
            if (tempoInicio) {
                const agora = Date.now();
                const tempoDecorrido = Math.floor((agora - tempoInicio) / 1000);
                document.getElementById('tempo').textContent = tempoDecorrido + 's';
            }
        }

        async function executarTeste() {
            if (executando) return;
            
            executando = true;
            tempoInicio = Date.now();
            
            // Resetar status
            etapas.forEach(etapa => {
                statusEtapas[etapa.id] = 'pending';
            });
            
            // Limpar timeline (manter t√≠tulo)
            const timeline = document.getElementById('timeline');
            const titulo = timeline.firstElementChild;
            timeline.innerHTML = '';
            timeline.appendChild(titulo);
            
            adicionarLog('info', 'Iniciando execu√ß√£o do teste completo...');
            
            // Iniciar timer
            intervaloTempo = setInterval(atualizarTempo, 1000);
            
            // Executar etapas sequencialmente
            for (const etapa of etapas) {
                if (!executando) break;
                
                statusEtapas[etapa.id] = 'in_progress';
                desenharFluxo();
                atualizarEstatisticas();
                adicionarLog('info', `Executando: ${etapa.name}...`);
                adicionarTimeline(etapa.id, 'in_progress');
                
                // Simular tempo de execu√ß√£o
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                if (!executando) break;
                
                // Simular sucesso ou erro (90% sucesso)
                const sucesso = Math.random() > 0.1;
                statusEtapas[etapa.id] = sucesso ? 'success' : 'error';
                
                desenharFluxo();
                atualizarEstatisticas();
                
                if (sucesso) {
                    adicionarLog('success', `‚úÖ ${etapa.name} conclu√≠do com sucesso`);
                    adicionarTimeline(etapa.id, 'success');
                } else {
                    adicionarLog('error', `‚ùå Erro em ${etapa.name}`);
                    adicionarTimeline(etapa.id, 'error');
                    break;
                }
            }
            
            if (executando) {
                const sucessos = Object.values(statusEtapas).filter(s => s === 'success').length;
                if (sucessos === etapas.length) {
                    adicionarLog('success', 'üéâ Teste completo executado com sucesso!');
                } else {
                    adicionarLog('error', '‚ö†Ô∏è Teste interrompido devido a erro');
                }
            }
            
            executando = false;
            clearInterval(intervaloTempo);
        }

        function resetarTeste() {
            executando = false;
            clearInterval(intervaloTempo);
            
            etapas.forEach(etapa => {
                statusEtapas[etapa.id] = 'pending';
            });
            
            document.getElementById('tempo').textContent = '0s';
            tempoInicio = null;
            
            desenharFluxo();
            atualizarEstatisticas();
            adicionarLog('info', 'Sistema resetado');
        }

        function simularErro() {
            if (!executando) {
                const etapaAleatoria = etapas[Math.floor(Math.random() * etapas.length)];
                statusEtapas[etapaAleatoria.id] = 'error';
                desenharFluxo();
                atualizarEstatisticas();
                adicionarLog('error', `Erro simulado em: ${etapaAleatoria.name}`);
                adicionarTimeline(etapaAleatoria.id, 'error');
            }
        }

        function pararTeste() {
            if (executando) {
                executando = false;
                clearInterval(intervaloTempo);
                adicionarLog('info', 'Execu√ß√£o interrompida pelo usu√°rio');
            }
        }

        // Auto-refresh
        function iniciarAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                if (document.getElementById('autoRefresh').checked && !executando) {
                    // Simular pequenas mudan√ßas nos dados
                    atualizarTempo();
                }
            }, 5000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            desenharFluxo();
            atualizarEstatisticas();
            iniciarAutoRefresh();
            
            adicionarLog('success', 'Dashboard inicializado com sucesso');
        });

        // Responsividade
        window.addEventListener('resize', function() {
            desenharFluxo();
        });
    </script>
</body>
</html>